# Running TCHSM in Intralabs


## Config

### TCHSM Configuration

To setup TCHSM you'll need the config files generated by the script on the TCHSM Repository. These confguration files need to be present on the nodes, preferably on `/etc/cryptoki_TCHSM.conf`  with the master node and on `/etc/TCHSM_node.conf` on the worker nodes.

You'll also need to have the OpenDNSSEC configuration files present in `/etc/opendnssec` on the master node.

## Installation

### TCHSM Master Node (OpenDNSSEC)
* Copy folder "docker-tchsm" on /etc or any place you like inside the node.
* Build docker images with the following commands:
```
docker build -t tchsm-lib-centos7 /path/to/docker-tchsm/lib/centos7
docker build -t tchsm-opendnssec /path/to/docker-tchsm/opendnssec
```
* Create docker container running OpenDNSSEC:
```
docker run --net=host -d -v /etc/opendnssec:/etc/opendnssec -v /etc/cryptoki_TCHSM.conf:/cryptoki_TCHSM.conf --name opendnssec tchsm-opendnssec
docker exec opendnssec rsyslogd
docker exec opendnssec ods-control start
```
* You can see the docker logs with the command: `docker exec opendnssec tail /var/log/messages [--follow|-f]`


### TCHSM Node
* Copy folder "docker-tchsm" on /etc or any place you like inside the node.
* Build docker image with the following commands:
```
docker build -t tchsm-node-alpine /path/to/docker-tchsm/node/alpine
```
* Create docker container running OpenDNSSEC:
```
docker run --net=host -d -v /etc/TCHSM_node.conf:/TCHSM_node.conf --name node-tchsm tchsm-node-alpine -c /TCHSM_node.conf
```
* You can see the docker logs with the command: `docker logs [--follow|-f] node-tchsm`

## Bind Setup

Now that OpenDNSSEC is running, to link it up with Bind you have to configure Bind to look for the signed zone. The path to the signed zone can be found on the `zonelist.xml` config file of OpenDNSSEC under the `<Output>` tag. You just have to change Bind's configuration file to point to the signed zone file rather than the unsigned one.

