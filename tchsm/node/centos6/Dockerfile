FROM centos:6

RUN yum install -y \
            autogen \
            bzip2 \
            cmake \
            curl \
            json-c-devel \
            git \
            gmp-devel \
            jansson-devel \
            libconfig-devel \
            libedit-devel \
            libuuid-devel \
            make \
            m4 \
            sqlite-devel

RUN curl -L https://people.centos.org/tru/devtools-2/devtools-2.repo -o /etc/yum.repos.d/devtools-2.repo && yum install -y devtoolset-2-gcc devtoolset-2-binutils devtoolset-2-gcc-c++

ENV PKG_CONFIG_PATH ${PKG_CONFIG_PATH}:/usr/local/lib/pkgconfig
ENV CXX /opt/rh/devtoolset-2/root/usr/bin/g++
ENV CC /opt/rh/devtoolset-2/root/usr/bin/cc

RUN curl -LO https://download.libsodium.org/libsodium/releases/libsodium-1.0.9.tar.gz \
 && tar -xzC /tmp -f libsodium-1.0.9.tar.gz && rm libsodium-1.0.9.tar.gz \
 && cd /tmp/libsodium-1.0.9/ && ./configure && make && make install \
 && cd / && rm -r /tmp/libsodium-1.0.9

RUN curl -LO https://github.com/zeromq/zeromq4-1/releases/download/v4.1.4/zeromq-4.1.4.tar.gz \
 && echo 'b632a4b6f8a14390dc17824e37ff7b10831ce2b4  zeromq-4.1.4.tar.gz' | sha1sum -c \
 && tar -xzC /tmp -f zeromq-4.1.4.tar.gz && rm zeromq-4.1.4.tar.gz \
 && cd /tmp/zeromq-4.1.4 && ./configure --with-libsodium && make && make install \
 && ldconfig \
 && cd / && rm -r /tmp/zeromq-4.1.4

RUN curl -LO http://ufpr.dl.sourceforge.net/project/mhash/mhash/0.9.9.9/mhash-0.9.9.9.tar.gz \
 && echo 'c898de5ea60d9e0873a1b73caa031bb1b5797c03  mhash-0.9.9.9.tar.gz' | sha1sum -c \
 && tar -xzC /tmp -f mhash-0.9.9.9.tar.gz && rm mhash-0.9.9.9.tar.gz \
 && cd /tmp/mhash-0.9.9.9 && ./configure && make && make install \
 && cd / && rm -r /tmp/mhash-0.9.9.9

RUN curl -LO http://www.hyperrealm.com/libconfig/libconfig-1.5.tar.gz \
 && tar -xzC /tmp -f libconfig-1.5.tar.gz && rm libconfig-1.5.tar.gz \
 && cd /tmp/libconfig-1.5 && ./configure && make install \
 && cd / && rm -r /tmp/libconfig-1.5

RUN cd /tmp && mkdir libtc && cd libtc \
 && git clone https://github.com/niclabs/tchsm-libtc.git \
 && cd tchsm-libtc && mkdir build && cd build && cmake .. && make install


RUN cd /tmp && mkdir libdtc && cd libdtc \
 && git clone https://github.com/niclabs/tchsm-libdtc.git \
 && cd tchsm-libdtc \
# TODO TEMPORAL
# && git checkout a9a3e299a46 \
 && mkdir build && cd build \
 && cmake  -DENABLE_CRYPTOKI=OFF .. \
 && make install

ENTRYPOINT ["/usr/local/bin/tchsm_node"]
CMD ["-c", "/etc/node.conf"]
